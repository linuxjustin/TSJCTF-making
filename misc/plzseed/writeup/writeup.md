# Plzseed Writeup

## 解法

世の中ではBittorrentで違法なRARファイルが共有されているというのを題材にしているが、正直あまり関係なく、普通にBitTorrentのプロトコルとRARのフォーマット知ってるかという問題である。

BitTorrentで300GBのRARファイルがダウンロードできるが、nginxによってダウンロード速度が8kB/sに制限されているため、すべてダウンロードするには1年ほどかかる。

300GBのRARファイルのすべてがフラグに関係あるとは思えないため、RARファイルの中でフラグに関係ある部分だけをダウンロードすることを思いつくはずである。(BitTorrentではクライアントがダウンロードしたいピースとそのオフセットをピアに要求することができる)

そのためにはまず、最小限のダウンロードでRARのファイルを列挙する必要があるが、これは一般的なRARファイルビューアが行っていることと同じである。

RARファイルは複数のチャンクから構成され、チャンクのヘッダーにはそのチャンクの大きさ (を計算するのに十分な情報) が記載されている。つまりファイルの最初からスキャンしていき、チャンクのヘッダーだけを拾って最後まで読んでやれば含まれるチャンクをすべて列挙することができる。

RARの1ファイルは1チャンクに対応しているため、含まれるファイルを列挙できる。これを行うと、dummyXXXXXという名前のデータの他にflag.jpgというファイルがあるのが見つかる。

あとは該当チャンクをまるごとダウンロードして (42KBあるので5秒程度かかる)、適切なRARヘッダーをくっつけて展開してやればflag.jpgを取り出すことができる。フラグは画像に記載してある。

つまづきポイントとして、RARフォーマットには4GB以上のファイルサイズに対応するための拡張仕様があり、これを正しく実装しないとクソデカdummyファイルを正しく読み飛ばせない。

ちなみにこの問題、HTTPサーバーなどでも同じような問題が構成できるが、あえてBitTorrentなのは、HTTPサーバーなどはローカルのファイルシステムにマウントして適当なRARビューアで閲覧すれば一瞬で解けてしまうからである。BitTorrentをマウントするシステムは流石に存在しない⋯⋯よね?

BitTorrentプロトコルの詳細は↓のページが参考になる。

https://wiki.theory.org/index.php/BitTorrentSpecification

RARファイルのフォーマットの詳細は↓のページが参考になる。

https://www.forensicswiki.org/wiki/RAR

## Flag

`TSGCTF{BE-SMART-AND-ILLEGAL}`