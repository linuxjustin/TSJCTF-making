# ffi Writeup

## 解法

ffi.ttf をインストールして問題文の指示通り適当に `TSGCTF{a}` とかタイプすると `TSGCTF{a} is incorrect` となるのがわかる。

Fontforge などで中身を見てみると `a` から `z` と `_` のグリフが 9 個ずつ余分に含まれていることがわかる。あと `T`, `S`, `G`, `C`, `T`, `F`, `{` の 7 文字も余分にあり、`} is incorrect` という 1 グリフと `} is correct` という 1 グリフもあるのが見える。そしてこれらのグリフにはいずれも文字コードが割り当てられていない。

これらの観察から、`TSGCTF{...} is correct` となるような `...` を見つける問題であると推測できる。

この問題のフォントは、フォントのグリフ置換という機能を用いて、

- グリフ「T」に続くグリフ「S」を、余分に用意した別の「S」（「S1」と呼ぶことにしよう）に置換する
    - 「S」と「S1」は形は同一なので目では区別がつかない
- グリフ「S1」に続くグリフ「G」を、「G1」に置換する
- グリフ「G1」に続くグリフ「C」を、「C1」に置換する

といった置換がされるようプログラムされている。これは、見方を変えると決定性有限オートマトンに見える。つまり「T」「S」「G」「C」……という文字を受け取り、「T」「S1」「G1」「C1」……という状態に遷移していく。遷移した状態の列がグリフ列として出力される。

このことに気づけば、あとは `}` が `} is correct` に置換されるようなオートマトンの状態遷移のパスを探す問題となる。フォントをデコンパイルするなどして置換規則のデータを取り出して `} is correct` のグリフから逆順に辿ればよい。

## Flag

`TSGCTF{ligature_state_machine}`
